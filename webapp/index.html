<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background-color: var(--tg-theme-bg-color, #fff); 
            color: var(--tg-theme-text-color, #000); 
            -webkit-tap-highlight-color: transparent;
        }
        .card { background-color: var(--tg-theme-secondary-bg-color, #f5f5f5); }
        .btn-primary { 
            background-color: var(--tg-theme-button-color, #3b82f6); 
            color: var(--tg-theme-button-text-color, #ffffff); 
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: rgba(0,0,0,0.1); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="pb-20">
    <div id="app" class="max-w-md mx-auto relative min-h-screen">
        
        <!-- Search Header -->
        <div class="sticky top-0 z-20 bg-[var(--tg-theme-bg-color)] p-3 shadow-sm">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search videos..." 
                    class="w-full p-2 pl-9 rounded-lg border border-gray-200 dark:border-gray-700 bg-[var(--tg-theme-secondary-bg-color)] text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg class="w-4 h-4 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>

        <!-- Banners -->
        <div id="bannerContainer" class="p-3 hidden">
            <div class="overflow-x-auto hide-scrollbar flex gap-3 snap-x snap-mandatory" id="bannerList">
                <!-- Banners injected here -->
            </div>
        </div>

        <!-- Categories -->
        <div class="px-3 mb-2 sticky top-[60px] z-10 bg-[var(--tg-theme-bg-color)] py-2">
            <div class="flex gap-2 overflow-x-auto hide-scrollbar" id="categoryList">
                <button onclick="selectCategory(0)" class="cat-btn px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-blue-500 text-white" data-id="0">
                    All
                </button>
                <!-- Categories injected here -->
            </div>
        </div>

        <!-- Sort Tabs -->
        <div class="px-3 mb-3 flex gap-4 text-sm text-gray-500 border-b border-gray-100 dark:border-gray-800">
            <button onclick="setSort('latest')" id="sort-latest" class="pb-2 font-medium text-blue-500 border-b-2 border-blue-500">Latest</button>
            <button onclick="setSort('hot')" id="sort-hot" class="pb-2 font-medium">Hot</button>
        </div>

        <!-- Video List -->
        <div id="videoList" class="px-3 grid grid-cols-1 gap-4">
            <!-- Videos injected here -->
        </div>

        <!-- Loading / No More -->
        <div id="loading" class="py-6 text-center text-gray-400 text-xs hidden">Loading...</div>
        <div id="noMore" class="py-6 text-center text-gray-400 text-xs hidden">No more videos</div>

        <!-- Bottom Bar (User Info) -->
        <div class="fixed bottom-0 left-0 right-0 bg-[var(--tg-theme-secondary-bg-color)] border-t border-gray-200 dark:border-gray-800 p-3 flex justify-between items-center z-30 max-w-md mx-auto">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs font-bold" id="userAvatar">U</div>
                <div class="flex flex-col">
                    <span class="text-xs font-bold truncate w-24" id="userName">User</span>
                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-200 dark:bg-gray-700" id="userStatus">Free</span>
                </div>
            </div>
            <button onclick="openPlans()" class="btn-primary px-4 py-1.5 rounded-lg text-xs font-bold shadow-lg">
                Upgrade VIP
            </button>
        </div>

        <!-- Plans Modal -->
        <div id="plansModal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4">
            <div class="bg-[var(--tg-theme-bg-color)] rounded-xl w-full max-w-sm p-5 shadow-2xl transform transition-all">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Choose Plan</h3>
                    <button onclick="closePlans()" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>
                <div id="plansList" class="space-y-3">
                    <!-- Plans injected here -->
                </div>
                <div class="mt-4 text-center text-xs text-gray-400">
                    Payment via Telegram Bot
                </div>
            </div>
        </div>

    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // State
        let state = {
            user: null,
            isVip: false,
            botUsername: '',
            categories: [],
            banners: [],
            videos: [],
            page: 1,
            loading: false,
            hasMore: true,
            currentCat: 0,
            currentSort: 'latest',
            q: ''
        };

        // API
        const API_BASE = '/api/webapp';
        const headers = {
            'X-Telegram-Init-Data': tg.initData
        };

        async function init() {
            try {
                // Auth
                const authRes = await fetch(`${API_BASE}/auth`, { headers });
                if (authRes.status === 401) {
                    alert("Authentication failed. Please open from Telegram.");
                    return;
                }
                const authData = await authRes.json();
                state.user = authData.user;
                state.isVip = authData.isVip;
                state.botUsername = authData.bot_username || '';
                updateUserUI();

                // Config
                const cfgRes = await fetch(`${API_BASE}/config`, { headers });
                const cfg = await cfgRes.json();
                state.categories = cfg.categories || [];
                state.banners = cfg.banners || [];
                renderCategories();
                renderBanners();

                // Initial Load
                loadVideos(true);

                // Scroll listener
                window.addEventListener('scroll', () => {
                    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                        loadVideos();
                    }
                });
                
                // Search listener
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        state.q = e.target.value.trim();
                        loadVideos(true);
                    }
                });

            } catch (e) {
                console.error(e);
                tg.showAlert("Failed to load app");
            }
        }

        async function loadVideos(reset = false) {
            if (state.loading) return;
            if (reset) {
                state.page = 1;
                state.hasMore = true;
                state.videos = [];
                document.getElementById('videoList').innerHTML = '';
                document.getElementById('noMore').classList.add('hidden');
            }
            if (!state.hasMore) return;

            state.loading = true;
            document.getElementById('loading').classList.remove('hidden');

            try {
                const url = `${API_BASE}/videos?page=${state.page}&limit=10&category_id=${state.currentCat}&sort=${state.currentSort}&q=${encodeURIComponent(state.q)}`;
                const res = await fetch(url, { headers });
                const data = await res.json();

                if (data.items.length === 0) {
                    state.hasMore = false;
                    document.getElementById('noMore').classList.remove('hidden');
                } else {
                    data.items.forEach(v => {
                        document.getElementById('videoList').appendChild(createVideoCard(v));
                    });
                    state.page++;
                }
            } catch (e) {
                console.error(e);
            } finally {
                state.loading = false;
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function createVideoCard(v) {
            const div = document.createElement('div');
            div.className = 'card rounded-xl overflow-hidden shadow-sm relative group cursor-pointer';
            
            // Format date
            const date = new Date(v.created_at).toLocaleDateString();
            
            // Lock icon
            const lockIcon = v.is_locked ? 
                `<div class="absolute top-2 right-2 bg-black/60 text-white p-1 rounded-full z-10"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div>` 
                : '';

            // Click handler
            div.onclick = () => {
                if (v.is_locked) {
                    // If locked, maybe show preview (free link) or prompt upgrade
                    if (v.free_link) {
                        tg.openTelegramLink(v.free_link);
                    } else {
                        // Prompt upgrade
                        openPlans();
                    }
                } else {
                    if (v.paid_link) tg.openTelegramLink(v.paid_link);
                }
            };

            div.innerHTML = `
                <div class="relative aspect-video bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                    <span class="text-4xl opacity-50">▶️</span>
                    ${lockIcon}
                    ${v.is_hot ? '<span class="absolute top-2 left-2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded">HOT</span>' : ''}
                </div>
                <div class="p-3">
                    <div class="text-sm font-medium line-clamp-2 leading-tight mb-2">${v.caption || 'No Title'}</div>
                    <div class="flex justify-between items-center text-[10px] text-gray-500">
                        <span>${v.view_count || 0} views</span>
                        <span>${date}</span>
                    </div>
                </div>
            `;
            return div;
        }

        function updateUserUI() {
            const u = state.user;
            if (u) {
                document.getElementById('userName').innerText = u.username || `User ${u.telegram_id}`;
                document.getElementById('userAvatar').innerText = (u.username || 'U')[0].toUpperCase();
            }
            const statusEl = document.getElementById('userStatus');
            if (state.isVip) {
                statusEl.innerText = "VIP Member";
                statusEl.className = "text-[10px] px-1.5 py-0.5 rounded bg-yellow-100 text-yellow-800 font-bold";
            } else {
                statusEl.innerText = "Free User";
                statusEl.className = "text-[10px] px-1.5 py-0.5 rounded bg-gray-200 text-gray-600";
            }
        }

        function renderCategories() {
            const list = document.getElementById('categoryList');
            // Keep "All" button
            const allBtn = list.firstElementChild;
            list.innerHTML = '';
            list.appendChild(allBtn);

            state.categories.forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'cat-btn px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)]';
                btn.innerText = c.name;
                btn.onclick = () => selectCategory(c.id);
                btn.dataset.id = c.id;
                list.appendChild(btn);
            });
        }

        function selectCategory(id) {
            state.currentCat = id;
            document.querySelectorAll('.cat-btn').forEach(b => {
                if (parseInt(b.dataset.id) === id) {
                    b.className = 'cat-btn px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-blue-500 text-white';
                } else {
                    b.className = 'cat-btn px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)]';
                }
            });
            loadVideos(true);
        }

        function setSort(s) {
            state.currentSort = s;
            document.getElementById('sort-latest').className = s === 'latest' ? 'pb-2 font-medium text-blue-500 border-b-2 border-blue-500' : 'pb-2 font-medium';
            document.getElementById('sort-hot').className = s === 'hot' ? 'pb-2 font-medium text-blue-500 border-b-2 border-blue-500' : 'pb-2 font-medium';
            loadVideos(true);
        }

        function renderBanners() {
            const container = document.getElementById('bannerContainer');
            const list = document.getElementById('bannerList');
            if (state.banners.length === 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            list.innerHTML = '';
            state.banners.forEach(b => {
                const div = document.createElement('div');
                div.className = 'snap-center shrink-0 w-full relative rounded-xl overflow-hidden aspect-[21/9] bg-gray-200';
                div.innerHTML = `<img src="${b.image_url}" class="w-full h-full object-cover" onclick="tg.openLink('${b.link_url}')">`;
                list.appendChild(div);
            });
        }

        async function openPlans() {
            const modal = document.getElementById('plansModal');
            const list = document.getElementById('plansList');
            list.innerHTML = '<div class="text-center">Loading...</div>';
            modal.classList.remove('hidden');
            
            try {
                const res = await fetch(`${API_BASE}/plans`, { headers });
                const data = await res.json();
                list.innerHTML = '';
                data.plans.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800';
                    div.innerHTML = `
                        <div>
                            <div class="font-bold">${p.title}</div>
                            <div class="text-xs text-gray-500">${p.days} Days</div>
                        </div>
                        <div class="font-bold text-blue-500">$${p.price}</div>
                    `;
                    div.onclick = () => {
                        // Redirect to bot start param
                        if (state.botUsername) {
                            tg.openTelegramLink(`https://t.me/${state.botUsername}?start=pay_${p.code}`);
                        } else {
                             tg.close();
                        }
                    };
                    list.appendChild(div);
                });
            } catch (e) {
                list.innerHTML = '<div class="text-red-500 text-center">Error loading plans</div>';
            }
        }

        function closePlans() {
            document.getElementById('plansModal').classList.add('hidden');
        }

        // Start
        init();
    </script>
</body>
</html>