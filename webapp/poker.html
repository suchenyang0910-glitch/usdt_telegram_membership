<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Poker</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); -webkit-tap-highlight-color: transparent; }
    .card { background-color: var(--tg-theme-secondary-bg-color, #f5f5f5); }
    .btn-primary { background-color: var(--tg-theme-button-color, #3b82f6); color: var(--tg-theme-button-text-color, #ffffff); }
    .btn-ghost { border: 1px solid rgba(0,0,0,0.15); }
  </style>
</head>
<body class="pb-10">
  <div class="max-w-md mx-auto p-4 space-y-4">
    <div class="flex items-center justify-between">
      <div class="font-bold text-lg">德州小程序</div>
      <button class="btn-ghost px-3 py-1.5 rounded-lg text-xs" onclick="refreshAll()">刷新</button>
    </div>

    <div class="card rounded-xl p-4 space-y-2">
      <div class="text-sm font-semibold">用户登录</div>
      <div class="text-xs text-gray-500" id="loginHint">加载中...</div>
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-bold" id="avatar">U</div>
        <div class="flex-1">
          <div class="text-sm font-bold truncate" id="who">-</div>
          <div class="text-xs text-gray-500 truncate" id="uid">-</div>
        </div>
      </div>
    </div>

    <div class="card rounded-xl p-4 space-y-3">
      <div class="text-sm font-semibold">记账</div>
      <div class="grid grid-cols-2 gap-2">
        <input id="amt" placeholder="金额(+/-)" class="p-2 rounded-lg border border-gray-200 bg-white text-sm" />
        <input id="note" placeholder="备注(可选)" class="p-2 rounded-lg border border-gray-200 bg-white text-sm" />
      </div>
      <button class="btn-primary w-full py-2 rounded-lg text-sm font-bold" onclick="addLedger()">添加</button>
      <div class="text-xs text-gray-500" id="ledgerHint"></div>
    </div>

    <div class="card rounded-xl p-4 space-y-2">
      <div class="text-sm font-semibold">余额</div>
      <div id="balances" class="text-xs text-gray-500">加载中...</div>
    </div>

    <div class="card rounded-xl p-4 space-y-2">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">流水</div>
        <div class="text-xs text-gray-500" id="ledgersHint"></div>
      </div>
      <div id="ledgers" class="text-xs text-gray-500">加载中...</div>
    </div>

    <div class="card rounded-xl p-4 space-y-3">
      <div class="text-sm font-semibold">牌面展示</div>
      <div class="flex gap-2 flex-wrap">
        <button class="btn-ghost px-3 py-1.5 rounded-lg text-xs" onclick="resetDeal()">重置</button>
        <button class="btn-ghost px-3 py-1.5 rounded-lg text-xs" onclick="dealHole()">发手牌</button>
        <button class="btn-ghost px-3 py-1.5 rounded-lg text-xs" onclick="dealFlop()">翻牌</button>
        <button class="btn-ghost px-3 py-1.5 rounded-lg text-xs" onclick="dealTurn()">转牌</button>
        <button class="btn-ghost px-3 py-1.5 rounded-lg text-xs" onclick="dealRiver()">河牌</button>
      </div>
      <div class="space-y-2">
        <div>
          <div class="text-xs text-gray-500 mb-1">我的手牌</div>
          <div id="hole" class="flex gap-2"></div>
        </div>
        <div>
          <div class="text-xs text-gray-500 mb-1">公共牌</div>
          <div id="board" class="flex gap-2 flex-wrap"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const headers = { 'X-Telegram-Init-Data': tg.initData };
    const API_BASE = '/api/webapp/poker';

    let me = null;
    let deck = [];
    let hole = [];
    let board = [];

    function suitSym(s){
      if(s==='S') return '♠';
      if(s==='H') return '♥';
      if(s==='D') return '♦';
      if(s==='C') return '♣';
      return s;
    }
    function cardText(c){
      if(!c) return '';
      return c.rank + suitSym(c.suit);
    }
    function cardEl(c){
      const t = document.createElement('div');
      t.className = 'w-12 h-16 rounded-lg border border-gray-200 bg-white flex items-center justify-center font-bold text-sm';
      t.innerText = cardText(c);
      if(c && (c.suit==='H' || c.suit==='D')) t.style.color = '#ef4444';
      return t;
    }
    function renderCards(){
      const holeEl = document.getElementById('hole');
      const boardEl = document.getElementById('board');
      holeEl.innerHTML = '';
      boardEl.innerHTML = '';
      hole.forEach(c=>holeEl.appendChild(cardEl(c)));
      board.forEach(c=>boardEl.appendChild(cardEl(c)));
    }
    function newDeck(){
      const suits = ['S','H','D','C'];
      const ranks = ['A','K','Q','J','T','9','8','7','6','5','4','3','2'];
      const d = [];
      suits.forEach(s=>ranks.forEach(r=>d.push({suit:s, rank:r})));
      for(let i=d.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        const tmp = d[i]; d[i]=d[j]; d[j]=tmp;
      }
      return d;
    }
    function drawOne(){
      return deck.length ? deck.pop() : null;
    }
    function resetDeal(){
      deck = newDeck();
      hole = [];
      board = [];
      renderCards();
    }
    function dealHole(){
      if(hole.length) return;
      if(!deck.length) resetDeal();
      hole = [drawOne(), drawOne()].filter(Boolean);
      renderCards();
    }
    function dealFlop(){
      if(board.length) return;
      if(!deck.length) resetDeal();
      if(!hole.length) dealHole();
      board = [drawOne(), drawOne(), drawOne()].filter(Boolean);
      renderCards();
    }
    function dealTurn(){
      if(board.length < 3) dealFlop();
      if(board.length >= 4) return;
      board.push(drawOne());
      renderCards();
    }
    function dealRiver(){
      if(board.length < 4) dealTurn();
      if(board.length >= 5) return;
      board.push(drawOne());
      renderCards();
    }

    async function jget(url){
      const r = await fetch(url, { headers });
      if(!r.ok) throw new Error(await r.text());
      return await r.json();
    }
    async function jpost(url, body){
      const r = await fetch(url, { method:'POST', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify(body||{}) });
      if(!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    function tableHtml(rows, cols){
      if(!rows || !rows.length) return "<div class='text-xs text-gray-500'>无数据</div>";
      const head = "<tr>" + cols.map(c=>`<th class='text-left py-1 pr-3 font-semibold'>${c}</th>`).join("") + "</tr>";
      const body = rows.map(r=>{
        return "<tr class='border-t border-gray-100'>" + cols.map(c=>`<td class='py-1 pr-3 align-top'>${(r[c]??"")}</td>`).join("") + "</tr>";
      }).join("");
      return `<table class="w-full text-xs">${head}${body}</table>`;
    }

    async function loadAuth(){
      try{
        const data = await jget(`${API_BASE}/auth`);
        me = data.user || null;
        const who = (me && me.username) ? me.username : (me ? ('User ' + me.telegram_id) : 'Unknown');
        document.getElementById('who').innerText = who;
        document.getElementById('uid').innerText = me ? ('telegram_id=' + me.telegram_id) : '-';
        document.getElementById('avatar').innerText = (who || 'U')[0].toUpperCase();
        document.getElementById('loginHint').innerText = '已登录';
      }catch(e){
        document.getElementById('loginHint').innerText = '登录失败';
        tg.showAlert('登录失败，请从 Telegram 打开小程序');
      }
    }

    async function loadBalances(){
      const el = document.getElementById('balances');
      try{
        const data = await jget(`${API_BASE}/balances`);
        const rows = (data.items||[]).map(x=>({
          username: x.username || ('uid ' + x.telegram_id),
          balance: x.balance
        }));
        el.innerHTML = tableHtml(rows, ['username','balance']);
      }catch(e){
        el.innerHTML = "<div class='text-xs text-gray-500'>加载失败</div>";
      }
    }

    async function loadLedgers(){
      const el = document.getElementById('ledgers');
      try{
        const data = await jget(`${API_BASE}/ledgers?limit=200&days=30`);
        const rows = (data.items||[]).map(x=>({
          time: (x.created_at||'').replace('T',' ').replace('Z',''),
          user: x.username || ('uid ' + x.telegram_id),
          amount: x.amount,
          note: x.note || ''
        }));
        document.getElementById('ledgersHint').innerText = '最近30天';
        el.innerHTML = tableHtml(rows, ['time','user','amount','note']);
      }catch(e){
        el.innerHTML = "<div class='text-xs text-gray-500'>加载失败</div>";
      }
    }

    async function addLedger(){
      const hint = document.getElementById('ledgerHint');
      hint.innerText = '';
      const amount = document.getElementById('amt').value.trim();
      const note = document.getElementById('note').value.trim();
      if(!amount){
        hint.innerText = '请输入金额';
        return;
      }
      try{
        await jpost(`${API_BASE}/ledger_add`, { amount, note });
        document.getElementById('amt').value = '';
        document.getElementById('note').value = '';
        hint.innerText = '已添加';
        await loadBalances();
        await loadLedgers();
      }catch(e){
        hint.innerText = '添加失败';
      }
    }

    async function refreshAll(){
      await loadBalances();
      await loadLedgers();
    }

    async function init(){
      resetDeal();
      await loadAuth();
      await refreshAll();
    }
    init();
  </script>
</body>
</html>

